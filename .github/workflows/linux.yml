name: Linux CI

on:
  push:
    branches:
        - master
        - dev
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 0 * * 1'

jobs:

  linux-build:
    name: Linux Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Install deps (Linux)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get -y update
          sudo apt-get remove php* msodbcsql17 mysql* powershell dotn*
          sudo apt-get -y update
          sudo ACCEPT_EULA=Y apt-get upgrade -y
          sudo apt-get install -q -y \
            curl python3 \
            libcurl4-openssl-dev libssl-dev
            software-properties-common autoconf git build-essential libtool \
            libprotobuf-c-dev libgmp-dev libsqlite3-dev python zip \
            jq libevent-dev pkg-config libcurl4-gnutls-dev cmake

      - name: Build (Linux)
        run: |
            export CHIPS_ROOT=$(pwd)
            export BDB_PREFIX="${CHIPS_ROOT}/db4"
            wget 'http://download.oracle.com/berkeley-db/db-4.8.30.NC.tar.gz'
            mkdir -p $BDB_PREFIX
            echo '12edc0df75bf9abd7f82f821795bcee50f42cb2e5f76a6a281b85732798364ef db-4.8.30.NC.tar.gz' | sha256sum -c
            tar -xzvf db-4.8.30.NC.tar.gz
            cd db-4.8.30.NC/build_unix/
            ../dist/configure -enable-cxx -disable-shared -with-pic -prefix=$BDB_PREFIX
            make -j$(nproc)
            make install

            cd $CHIPS_ROOT
            git clone https://github.com/jl777/chips3.git -b dev
            cd chips3/
            ./autogen.sh
            ./configure LDFLAGS="-L${BDB_PREFIX}/lib/" CPPFLAGS="-I${BDB_PREFIX}/include/" \
            -without-gui -without-miniupnpc --disable-tests --disable-bench --with-gui=no
            make -j$(nproc)

            ls -lad src/{chips-cli,chipsd}
